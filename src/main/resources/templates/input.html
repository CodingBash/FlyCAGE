<!DOCTYPE HTML>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" xmlns:th="http://www.thymeleaf.org">
<!--<![endif]-->
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="Basheer Becerra's personal website." />
<meta name="keywords"
	content="Basheer, Becerra, Bash, developer, entrepreneur, researcher" />
<meta name="author" content="Basheer Becerra" />

<!-- Facebook and Twitter integration -->
<meta property="og:title" content="" />
<meta property="og:image" content="" />
<meta property="og:url" content="" />
<meta property="og:site_name" content="" />
<meta property="og:description" content="" />
<meta name="twitter:title" content="" />
<meta name="twitter:image" content="" />
<meta name="twitter:url" content="" />
<meta name="twitter:card" content="" />

<title>FlyCAGE</title>

<!-- Google Fonts -->
<link
	href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,700|Monsterrat:400,700|Merriweather:400,300italic,700'
	rel='stylesheet' type='text/css'></link>
<link
	href='https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/css/tether.min.css'
	rel='stylesheet' type='text/css'></link>
<!-- Latest compiled and minified CSS -->
<link
	href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M"
	crossorigin="anonymous"></link>
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-switch/3.3.4/css/bootstrap2/bootstrap-switch.min.css"></link>
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.css" />
<!-- Externalize CSS -->
<style>
body {
	background-color: #E4E4E4
}

.table-wrapper {
	width: 95% !important;
	margin: auto;
}

#query-comment {
	width: 100%;
	height: 200px;
}

.extra-space {
	margin-top: 25px;
}

.query-inputs {
	width: 100% !important;
	margin: auto;
}

/* TODO: Quick Workaround to differentiate between main panels, and expression stage panels. Make more organized */
.panel-header {
	height: 10em;
}

/* For Plotlyjs CSS */
div[id*="-graph"] {
	width: 100%;
}

</style>
<style>
.card {
	border-radius: 0;
	transition: box-shadow 0.5s;
}

.card-body {
	background-color: #fff !important;
}

.card-header {
	color: #fff !important;
	background-color: #5C0075 !important;
	padding: 25px;
	border-bottom: 1px solid transparent;
	border-top-left-radius: 0px;
	border-top-right-radius: 0px;
	border-bottom-left-radius: 0px;
	border-bottom-right-radius: 0px;
}

.form-card {
	
}

.form-card-header {
	background-color: #fff !important;
}

.row {
	margin-top: 5px;
	margin-bottom: 5px;
}
</style>

<style th:inline="text">
td.details-control {
	background: url([[@{/images/details_open.png}]]) no-repeat center center;
	cursor: pointer;
}

tr.shown td.details-control {
	background: url([[@{/images/details_close.png}]]) no-repeat center
		center;
}
</style>
<style>
/* Style the accordion checkboxes */
.sub-checkbox-div {
	padding-left: 50px !important;
}
</style>
<style>
/* For jQuery UI slider */
div[id*="custom-handle"] {
	width: 3em !important;
	height: 1.6em !important;
	top: 50% !important;
	margin-top: -.8em;
	text-align: center;
	line-height: 1.6em;
}

div[id*="slider"] .ui-slider-range {
	background: #5C0075 !important;
}

div[id*="slider"] .ui-slider-handle {
	border-color: #5C0075 !important;
}

/* For required astrick, add to external css */
.form-group.required .control-label:after {
	content: "*";
	color: red;
}

/*For navbar */
nav {
	background-color: #E4E4E4 !important;
}
</style>

</head>
<body>
	<div th:include="fragments :: navbar"></div>
	<div class="container-fluid">
		<div class="row">
			<div class="col-md-12">
				<div th:include="fragments :: exception"></div>
			</div>
		</div>
		<div class="row">
			<div class="col-md-12">
				<div th:include="fragments :: gene-form"></div>
			</div>
		</div>
	</div>

	<div id="slider">
		<div id="custom-handle" class="ui-slider-handle"></div>
	</div>


	<!-- SCRIPTS -->
	<script src="https://code.jquery.com/jquery-3.2.1.min.js"
		integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
		crossorigin="anonymous"></script>
	<!-- Latest compiled and minified JavaScript -->
	<!-- TODO: May not need Tether.js for bootstrap 4-beta -->
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"
		integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb"
		crossorigin="anonymous"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"
		integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
		crossorigin="anonymous"></script>
	<script
		src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js"
		integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1"
		crossorigin="anonymous"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-switch/3.3.4/js/bootstrap-switch.min.js">
		
	</script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
		integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
		crossorigin="anonymous"></script>
	<!-- BELOW PlotlyJS scripts -->
	<script src="https://d3js.org/d3.v3.min.js"></script>
	<script src="https://cdn.plot.ly/plotly-1.2.0.min.js"></script>
	<div th:include="fragments :: form-expression-stage-checkbox-selection"></div>
	<script>
		$(function() {
			$('[data-toggle="tooltip"]').tooltip()
		})
	</script>

	<script th:inline="javascript">
		var DEFAULT_VALUE = 100;
		/*<![CDATA[*/
		var geneResultCount = /*[[${geneForm.geneResultCount}]]*/-1;

		geneResultCount = (geneResultCount == null ? DEFAULT_VALUE
				: geneResultCount);

		/*]]>*/

		$(function() {
			var handle = $("#custom-handle");

			var createEvent = function(sliderElement) {
				/*
				 * If input = default (meaning the form is fresh)
				 * Do the initial createSlider event
				 */
				$("#slider").slider("option", "value", geneResultCount); // Value set to default TODO: must be in sync with input box
				handle.text(geneResultCount); // Set default value to handle
			};

			var slideEvent = function(value) {
				handle.text(value);

				var value = $("#slider").slider("option", "value");
				$('#result-count').val(value);
			};

			var changeEvent = function() {
				var value = $("#slider").slider("option", "value");
				$('#result-count').val(value);
			};

			$("#slider").slider({
				orientation : "horizontal",
				range : "min",
				create : function() {
					createEvent(this)
				},
				slide : function(event, ui) {
					slideEvent(ui.value);
				},
				change : function(event, ui) {
					changeEvent();
				}
			});
			$("#slider").slider("option", "min", 2); // Min for correlation to work
			$("#slider").slider("option", "max", 500); // Max genes recommended (may be overrided by input number box)

			$('#result-count').on('change', function() {
				var val = $('#result-count').val();
				$("#slider").slider("option", "value", val);
				slideEvent(val);
			});
		});
	</script>
	<script th:inline="javascript">
		/* for custom data sliders */
		/*<![CDATA[*/
		var expressionStageOptions = /*[[${expressionStageOptions}]]*/[];
		
		var DEFAULT_CUSTOM_DATA = 0;

		expressionStageOptions.expressionStageGroupList
				.forEach(function(expressionStageGroup) {
					expressionStageGroup.expressionStageList
							.forEach(function(expressionStage) {
								$(function() {
									var sliderId = "#"
											+ expressionStageGroup.groupId
											+ '-'
											+ expressionStage.expressionStageId
											+ "-slider"
									var sliderObject = $(sliderId);
									var handleObject = $("#"
											+ expressionStageGroup.groupId
											+ '-'
											+ expressionStage.expressionStageId
											+ "-custom-handle");
									var inputObject = $("#"
											+ expressionStageGroup.groupId
											+ '-'
											+ expressionStage.expressionStageId
											+ "-custom-input");

									var createEvent = function(sliderElement) {
										/*
										 * If input = default (meaning the form is fresh)
										 * Do the initial createSlider event
										 */
										sliderObject.slider("option", "value",
												DEFAULT_CUSTOM_DATA); // Value set to default TODO: must be in sync with input box
										handleObject.text(DEFAULT_CUSTOM_DATA); // Set default value to handle
									};

									var slideEvent = function(value) {
										handleObject.text(value);
										inputObject.val(value);
										
										// Change identical sliders
										$(
												"div[id$='"
														+ '-'
														+ expressionStage.expressionStageId
														+ "-slider']").not(
												sliderId).slider("option",
												"value", value);
									};

									// TODO: this event is called on pageLoad for all sliders, thus reducing performance. Optimize
									var changeEvent = function(value) {
										inputObject.val(value);
										handleObject.text(value);
									};
									
									// TODO: Move more logic to this event
									var stopEvent = function(value) {
										// Update Plotlyjs. Commenting out since checkbox event fixed
										//updatePlotly(expressionStageGroup.groupId, expressionStage.expressionStageId);
										// TODO: Modularize this
										// Condition prevents change on pageload. Maybe wrap around all method calls
										if (value != 0) {
											// Change identical subcheckboxes
											programmaticallyChangeSubCheckbox(
													sliderObject
															.parent()
															.parent()
															.find(
																	"input[type='checkbox']:checkbox"),
													"-custom-data-", true);

											// TODO: Modularize this logic (although they are slightly different
											var oneChecked = false;
											var allTrue = true;
											$(
													"input[id$='-custom-data-sub-checkbox']")
													.each(
															function(index,
																	currentElement) {
																if (currentElement.checked == true) {
																	oneChecked = true;
																} else if (currentElement.checked == false) {
																	allTrue = false;
																}
															});
											$("#insert-gene").prop("required",
													!oneChecked);
										}

									}

									sliderObject.slider({
										orientation : "horizontal",
										range : "min",
										create : function() {
											createEvent(this)
										},
										slide : function(event, ui) {
											slideEvent(ui.value);
										},
										change : function(event, ui) {
											changeEvent(ui.value);
										},
										stop : function(event, ui) {
											stopEvent(ui.value);
										}
									});
									sliderObject.slider("option", "min", 0);
									sliderObject.slider("option", "max", 100);
									// MAKE SURE STEP IS SAME AS NUMBER INPUT ELEMENT
									sliderObject.slider("option", "step", 1);

									inputObject.on('change', function() {
										var val = inputObject.val();
										sliderObject.slider("option", "value",
												val);
										slideEvent(val);
									});
								});
							});
				});

		// If custom-data form being used, remove target gene form requirement
		$("input[id$='-custom-data-sub-checkbox'], input[id$='-custom-data-main-checkbox']").on("change",
						function() {
							// TODO: Modularize this logic (although they are slightly different
							// REMOVE TARGET GENE FORM REQUIREMENT
							var oneChecked = false;
							var allTrue = true;
							$("input[id$='-custom-data-sub-checkbox']")
									.each(
											function(index, currentElement) {
												if (currentElement.checked == true) {
													oneChecked = true;
												} else if (currentElement.checked == false) {
													allTrue = false;
												}
											});
							$("#insert-gene").prop("required", !oneChecked);
						});
		
		function updatePlotly(groupId, expressionStageId){
			// Get jQuery element objects
			var checkBox = $("#" + groupId + "-" + expressionStageId + "-custom-data-sub-checkbox");
			var inputField = $("#" + groupId + "-" + expressionStageId + "-custom-input");
			
			// TODO: Not sure why I need ["0"] to access checked, but it works
			var checked = checkBox["0"].checked;
			var name = checkBox.attr("data-stage");
			
			// TODO: Find way to increase performance instead of linear search 
			var findIndex = function(title){
				for(var i = 0; i < allExpressionStages.length; i++){
					// TODO: If title is changed to id, this condition will always fail, and never update plot					
					if(allExpressionStages[i].expressionStageTitle == title){
						return allExpressionStages[i].expressionStageNumericalId;
					}
				}	
				return -1;
			};
			
			var expressionTitle = name.substring(name.indexOf('-') + 1);
			var allExpressionStages = expressionStageOptions.expressionStageList;
			if(checked == true){
				
				var value = inputField.val();
				// Find index of selected stage
				var index = findIndex(expressionTitle);
				
				if (index != -1){
					var plotDivId = "custom-data-plot";
					var plotDiv = document.getElementById(plotDivId);
					var plotData = plotDiv.data;
					var expressionData = plotData[0].y;
					var expressionTexts = plotData[0].text;
					var newExpressionData = expressionData.slice(0); // clone
					var newExpressionTexts  = expressionTexts.slice(0); // clone
					
					/*
					 * Improve expression insertion algorithm
					 */
					var insertionFlag = false;
					for(var i = 0; i < expressionTexts.length && insertionFlag != true; i++){
						// TODO: Handle equal cases if need be
						var currentIndex = findIndex(expressionTexts[i]);
						if(currentIndex == index){
							// If stage is already in plot -> update value
							newExpressionData[i] = value;
							insertionFlag = true;
						} else if(findIndex(expressionTexts[i]) > index){
							newExpressionData.splice(i, 0, value);
							newExpressionTexts.splice(i, 0, expressionTitle);
							insertionFlag = true;
						}
					}
					if(insertionFlag == false){
						newExpressionData.push(value);
						newExpressionTexts.push(expressionTitle);
					}
					
					var update = {
							y: [newExpressionData],
							text: [newExpressionTexts]
					};
					Plotly.restyle(plotDiv, update);
				}
			} else { 
				// Remove from plot
				
				// TODO: Modularize below (in both conditions)
				// Find index of selected stage
				var index = findIndex(expressionTitle);
				
				if (index != -1){
					var plotDivId = "custom-data-plot";
					var plotDiv = document.getElementById(plotDivId);
					var plotData = plotDiv.data;
					var expressionData = plotData[0].y;
					var expressionTexts = plotData[0].text;
					var newExpressionData = expressionData.slice(0); // clone
					var newExpressionTexts  = expressionTexts.slice(0); // clone
					
					/*
					 * Improve expression removal algorithm
					 */
					for(var i = 0; i < expressionTexts.length; i++){
						if(findIndex(expressionTexts[i]) == index){
							newExpressionData.splice(i, 1);
							newExpressionTexts.splice(i, 1);
							break;
						}		
					}
					var update = {
							y: [newExpressionData],
							text: [newExpressionTexts]
					};
					Plotly.restyle(plotDiv, update);
				}
			}
		}
		// Update plotly when checkbox updates
		$("input[id$='-custom-data-sub-checkbox']").on("change",
				function() {
			var combinedId = this.id.substring(0, this.id.indexOf("-custom-data-sub-checkbox"));
			var groupId = combinedId.substring(0, combinedId.indexOf("-"));
			var expressionStageId = combinedId.substring(combinedId.indexOf("-") + 1);
			updatePlotly(groupId, expressionStageId);
		});
		
		
		$("#show-form-link").on("click", function() {
			$("#custom-data-form").slideDown("fast", function() {
			});
		});
		/*]]>*/
	</script>
	<script>
		/*
		 * Custom Data Checkbox custom logic
		 */
		$("input[type='checkbox'][class*='custom-data']:checkbox").prop(
				'checked', false).trigger("change");
	</script>
	<script>
		// TODO: Using expressionStageOptions from selection form script. Organize better
		
		/*
		 * TODO: MODULARIZE THIS JAVASCRIPT. Same as #attachPlotGraphic on output page
		 */
		var plotDivId = "custom-data-plot";

		// EEG MAGNITUDE
		var correlationData = [ {
			name : "INPUT GENE",
			y : [],
			mode : 'lines+markers',
			text : [],
			marker : {
				color : 'blue',
				size : 8
			},
			line : {
				width : 4
			}
		} ];
		Plotly.plot(plotDivId, correlationData, {
			title : 'Custom Expression Data',
			xaxis : {
				title : "Expression Stage"
			},
			yaxis : {
				title : "Expression Score",
				range : [0, 100]
			},
			width : $('#plot-container').innerWidth() * .80
		});

		var d3 = Plotly.d3;
		var gd1 = d3.select('div[id="' + plotDivId + '"]');

		// TODO: Expected conflict when resizing plots with different purposes
		function plotsResize() {
			// Getting the width of .content
			var newTableWidth = $('#plot-container').innerWidth() * .95;
			var newPlotWidth = $('#plot-container').innerWidth() * .85;

			// Apply width and height to two divs that are created by 
			// Plotly. Fixed some issue swith hidden overfull elements.
			$("table[id$=-results]").css({
				"width" : newTableWidth + "px",
			});

			$(".js-plotly-plot").css({
				"width" : newPlotWidth + "px",
			});
			$(".plotly").css({
				"width" : newPlotWidth + "px",
			});

			// Applying width and height to a new variable for Plotly
			var update = {
				width : newPlotWidth,
			};
			// Using Plotly's relayout-function with graph-name and 
			// the variable with the new height and width
			Plotly.relayout(gd1.node(), update);
		}

		$(window).resize(function() {
			plotsResize();
		});

		plotsResize();
	</script>

</body>
</html>