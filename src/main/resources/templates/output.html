<!DOCTYPE HTML>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" xmlns:th="http://www.thymeleaf.org">
<!--<![endif]-->
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="Basheer Becerra's personal website." />
<meta name="keywords"
	content="Basheer, Becerra, Bash, developer, entrepreneur, researcher" />
<meta name="author" content="Basheer Becerra" />

<!-- Facebook and Twitter integration -->
<meta property="og:title" content="" />
<meta property="og:image" content="" />
<meta property="og:url" content="" />
<meta property="og:site_name" content="" />
<meta property="og:description" content="" />
<meta name="twitter:title" content="" />
<meta name="twitter:image" content="" />
<meta name="twitter:url" content="" />
<meta name="twitter:card" content="" />

<title>FlyCorr</title>

<!-- Google Fonts -->
<link
	href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,700|Monsterrat:400,700|Merriweather:400,300italic,700'
	rel='stylesheet' type='text/css'></link>
<link
	href='https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/css/tether.min.css'
	rel='stylesheet' type='text/css'></link>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css"
	integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ"
	crossorigin="anonymous"></link>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet"
	href="https://cdn.datatables.net/1.10.15/css/jquery.dataTables.min.css" />
<link rel="stylesheet"
	href="https://cdn.datatables.net/buttons/1.3.1/css/buttons.dataTables.min.css" />
<link rel="stylesheet"
	href="https://cdn.datatables.net/responsive/2.1.1/css/responsive.dataTables.min.css" />
</head>
<style>
body {
	background-color: #E4E4E4
}

.table-wrapper {
	width: 95% !important;
	margin: auto;
}

#query-comment {
	width: 100%;
	height: 200px;
}

.extra-space {
	margin-top: 25px;
}

.query-inputs {
	width: 100% !important;
	margin: auto;
}

/* TODO: Quick Workaround to differentiate between main panels, and expression stage panels. Same with the other psuedopanel stylers Make more organized */
.panel-header {
	height: 10em;
}

/* For Plotlyjs CSS */
div[id*="-graph"] {
	width: 100%;
}
</style>
<style>
.panel {
	border: 1px solid #5C0075;
	border-radius: 0;
	transition: box-shadow 0.5s;
	border-radius: 0;
}

.panel-block {
	background-color: #fff !important;
}

.panel-header {
	color: #fff !important;
	background-color: #5C0075 !important;
	padding: 25px;
	border-bottom: 1px solid transparent;
	border-top-left-radius: 0px;
	border-top-right-radius: 0px;
	border-bottom-left-radius: 0px;
	border-bottom-right-radius: 0px;
	border-bottom: 1px solid transparent;
}

.row {
	margin-top: 5px;
	margin-bottom: 5px;
}
</style>

<style th:inline="text">
td.details-control {
	background: url([[@{/images/details_open.png}]]) no-repeat center center;
	cursor: pointer;
}

tr.shown td.details-control {
	background: url([[@{/images/details_close.png}]]) no-repeat center
		center;
}
</style>
<!-- TODO: Make form and query on top during lg, and side-by-side during lower -->
<body>
	<div class="container-fluid">
		<div class="text-xs-center"></div>
		<div class="row">
			<div class="col-lg-4">
				<div class="row">
					<div class="col-md-12">
						<div class="card panel">
							<div class="card-header panel-header text-center">
								<h2>Query</h2>
								<h4>Shown below is the input query</h4>
							</div>
							<div class="card-block panel-block">
								<div class="container-fluid">
									<div class="row">
										<div class="col-md-12">
											<div class="row extra-space"></div>
											<div class="row">
												<div class="col-md-6 text-xs-center">
													<label for="input-identifier">Input Identifier:</label>
												</div>
												<div class="col-md-6 text-xs-left">
													<input type="text" id="input-identifier"
														class="query-inputs"
														th:value="${geneForm.inputIdentifier}" readonly="readonly" />
												</div>
											</div>
											<div class="row extra-space"></div>
											<div class="row">
												<div class="col-md-6 text-xs-center">
													<label for="gene-species">Organism:</label>
												</div>
												<div class="col-md-6 text-xs-left">
													<input type="text" id="gene-species" class="query-inputs"
														th:value="${geneForm.geneSpecies}" readonly="readonly" />
												</div>
											</div>
											<div class="row extra-space"></div>
											<div class="row">
												<div class="col-md-6 text-xs-center">
													<label for="correlation-options">Correlation:</label>
												</div>
												<div class="col-md-6 text-xs-left">
													<input type="text" id="correlation-options"
														class="query-inputs" readonly="readonly" />
												</div>
											</div>
											<div class="row extra-space"></div>
											<div class="row">
												<div class="col-md-6 text-xs-center">
													<label for="query-comment">Comment:</label>
												</div>
												<div class="col-md-6 text-xs-left">
													<textarea id="query-comment"
														th:text="${geneForm.queryComment}" readonly="readonly"></textarea>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-md-12">
						<div th:include="fragments :: gene-form" class="hidden-md-down"></div>
					</div>
				</div>
			</div>
			<div class="col-lg-8">
				<div class="row">
					<div class="col-12">
						<div id="result-panel" class="card panel">
							<div class="card-header panel-header text-center">
								<h2>Results</h2>
								<h4>Shown below are all of the highly correlated genes

									based on mRNA expression by stage data</h4>
							</div>
							<div class="card-block panel-block">
								<div class="row extra-space"></div>
								<div class="row table-row">
									<div class="table-wrapper">
										<table id="correlation-results"
											class="stripe row-border compact nowrap"
											style="width: 100% !important; margin: auto !important;"
											cellspacing="0">
											<thead>
												<tr>
													<!--  TODO: Make fragment for these -->
													<th></th>
													<th><a href="#correlation-results"
														data-toggle="tooltip" title="Rank by R-VAL"
														data-placement="top">RANK</a></th>
													<th><a href="#correlation-results"
														data-toggle="tooltip" title="FlyBase database ID"
														data-placement="top">DB ID</a></th>
													<th><a href="#correlation-results"
														data-toggle="tooltip" title="FlyBase secondary ID"
														data-placement="top">2<sup>nd</sup> ID
													</a></th>
													<th><a href="#correlation-results"
														data-toggle="tooltip" title="Name of gene"
														data-placement="top">GENE NAME</a></th>
													<th><a href="#correlation-results"
														data-toggle="tooltip" title="Pearson's R coefficient"
														data-placement="top">R VAL</a></th>
													<th><a href="#correlation-results"
														data-toggle="tooltip" title="Correlation p-value"
														data-placement="top">P VAL</a></th>
													<th><a href="#correlation-results"
														data-toggle="tooltip" title="Button actions on row entry"
														data-placement="top">ACTION</a></th>
												</tr>
											</thead>
											<tbody></tbody>
											<tfoot>
												<tr>
													<!--  TODO: Make fragment for these -->
													<th></th>
													<th><a href="#correlation-results"
														data-toggle="tooltip" title="Rank by R-VAL"
														data-placement="top">RANK</a></th>
													<th><a href="#correlation-results"
														data-toggle="tooltip" title="FlyBase database ID"
														data-placement="top">DB ID</a></th>
													<th><a href="#correlation-results"
														data-toggle="tooltip" title="FlyBase secondary ID"
														data-placement="top">2<sup>nd</sup> ID
													</a></th>
													<th><a href="#correlation-results"
														data-toggle="tooltip" title="Name of gene"
														data-placement="top">GENE NAME</a></th>
													<th><a href="#correlation-results"
														data-toggle="tooltip" title="Pearson's R coefficient"
														data-placement="top">R VAL</a></th>
													<th><a href="#correlation-results"
														data-toggle="tooltip" title="Correlation p-value"
														data-placement="top">P VAL</a></th>
													<th><a href="#correlation-results"
														data-toggle="tooltip" title="Button actions on row entry"
														data-placement="top">ACTION</a></th>
												</tr>
											</tfoot>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-md-12 ">
						<div th:include="fragments :: gene-form" class="hidden-lg-up"></div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="https://code.jquery.com/jquery-3.2.1.min.js"
		integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
		crossorigin="anonymous"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"
		integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb"
		crossorigin="anonymous"></script>
	<script
		src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js"
		integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn"
		crossorigin="anonymous"></script>
	<script
		src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>

	<!-- BELOW: Links for datatable buttons -->
	<script
		src="https://cdn.datatables.net/buttons/1.3.1/js/dataTables.buttons.min.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
	<script
		src="https://cdn.rawgit.com/bpampuch/pdfmake/0.1.27/build/pdfmake.min.js"></script>
	<script
		src="https://cdn.rawgit.com/bpampuch/pdfmake/0.1.27/build/vfs_fonts.js"></script>
	<script
		src="https://cdn.datatables.net/buttons/1.3.1/js/buttons.html5.min.js"></script>

	<script
		src="https://cdn.datatables.net/responsive/2.1.1/js/dataTables.responsive.min.js"></script>
	<!-- ABOVE: Links for datatable buttons -->
	<!-- BELOW PlotlyJS scripts -->
	<script src="https://d3js.org/d3.v3.min.js"></script>
	<script src="https://cdn.plot.ly/plotly-1.2.0.min.js"></script>
	<!-- ABOVE PlotlyJS scripts -->

	<script th:inline="javascript">
	/*<![CDATA[*/
		var correlationOptions = [[${geneForm.correlationOptions}]];
	    var finalResponseCorrelationResult = [[${result}]];

	/*]]>*/
	</script>
	<script>
	
	$(function () {
		  $('[data-toggle="tooltip"]').tooltip()
		})
	</script>
	<script>
		/*<![CDATA[*/
			var t = $('#correlation-results').DataTable({
			  "columnDefs": [ {
			      "targets": 0,
			      "data": null,
			      "orderable": false,
			      "className": 'details-control',
			      "defaultContent": ''
			    },  { responsivePriority: 1, targets: 0 },
		        { responsivePriority: 2, targets: 2 },
		        { responsivePriority: 3, targets: 5 },
		        { responsivePriority: 4, targets: 6 },
		        { responsivePriority: 5, targets: 7 },
		        { responsivePriority: 6, targets: 4 },
		        {
		            targets: 4,
		            render: function ( data, type, row ) {
		                return (data.length > 25) ? data.substr( 0, 25 ) + "..." : data;
		            }
		        }],
				aaSorting : [ [ 5, 'des' ] ],
				"pageLength" : 25,
				dom: 'Bfrtip',
				buttons: [
		            'copy', 'csv', 'excel', 'pdf'
		        ],
		        "responsive": {
		            "details": false
		        }
			});
			
		
			/* Formatting function for row details - modify as you need */
		    function attachPlotHtml(pairwiseCorrelationDataAjaxRequestBody) {
		    	// TODO: Modularize these two variables
				var plotDivId= pairwiseCorrelationDataAjaxRequestBody.inputGene + '-' + pairwiseCorrelationDataAjaxRequestBody.targetGene + '-graph';
		        var tableIdExtender = pairwiseCorrelationDataAjaxRequestBody.inputGene + '-' + pairwiseCorrelationDataAjaxRequestBody.targetGene;
		    	
		    	var expressionStageMapping = '<div id="accordion-' + tableIdExtender+ '" role="tablist" aria-multiselectable="true">' +
				  '<div class="card">' +
				    '<div class="card-header" role="tab" id="heading-'+tableIdExtender+'">' +
				      '<h6 class="mb-0">' +
				        '<a class="collapsed" data-toggle="collapse" data-parent="#accordion-'+tableIdExtender+'" href="#collapse-'+tableIdExtender+'" aria-expanded="true" aria-controls="collapse-'+tableIdExtender+'">' +
				          'View Expression Stage Mapping' +
				        '</a>' +
				      '</h6>' +
				    '</div>' +
				    '<div id="collapse-'+tableIdExtender+'" class="collapse" role="tabpanel" aria-labelledby="heading-'+tableIdExtender+'">' +
				      '<div class="card-block">' +
				        'Anim pariatur cliche reprehenderit, enim eiusmod high sustainable VHS.' +
				      '</div>' +
				    '</div>' +
				  '</div>' +
				'</div>';
		    	
				/*
				 * HTML for the correlation-graph normalize button. Will be attached to the result string
				 */
				var normalizationButtonHtml = '<div class="text-center">'  +
		    	'<button type="button" class="btn btn-primary normalization-btn text-center">Normalize</button>' +
			    '</div>';
				/*
					TODO: Add Datatable - do this after adding sorting to the plotly
					TODO: May want to do this after the selective expression stage too (since I will need logic to make the table dynamic instead of static)
				*/
				return '<div id="' + plotDivId + '" class ="custom-plotly-plot"></div>' + normalizationButtonHtml +  expressionStageMapping;
		    }
			
			/*
			 * Normalization Container: Contains list of plots that has been normalized at least once
			 * List of objects:
				 {
				   plotDivId: string
				   isNormalized: boolean,
				   originalData: 2D list
				 }
			 */
			 var normalizationContainer = []
			// TODO: When closing the tab, normalization disappears and is unable to normalize again since the object is still in the container.
			// Either find a way to not reload the data (preferred, but longer), or remove the object when closing
			// Look into more exception scenarios
			/*
			 * On-click event for the normalize button
			 */
			$(document).on("click", '.normalization-btn',function(){
				normalizePlotData($(event.target).parents().children(".custom-plotly-plot")[0].id, event.target); // TODO: Find a better way to get the plot (this seems inefficient)
			});
			
			/*
			 * Function to normalize the plot data
			 */
			function normalizePlotData(plotDivId, eventTarget){
				// Retrieves all normalizes plots with the same plotDivId
				var normalizedPlotResults = $.grep(normalizationContainer, function(e){ return e.plotDivId == plotDivId; });
				
				// Retrieves the plot object using its ID
				var plotDiv = document.getElementById(plotDivId);
				
				// If there is no entry in the normalizationContainer (hasn't been normalized yet) or there is an entry but is not normalized -> let's normalize
				if(normalizedPlotResults.length == 0 || normalizedPlotResults[0].isNormalized == false){
					/*
					 * Retreive appropriate data
					 */
					var plotData = plotDiv.data;
					var inputGeneData = plotData[1].y;
					var targetGeneData = plotData[0].y;
					var newInputGeneData = [];
					var newTargetGeneData = [];
					
					/*
					 * Retreive max/min of both sets (used for normalization)
					 */
					var inputMax = Math.max.apply(null, inputGeneData);
					var inputMin = Math.min.apply(null, inputGeneData);
					var targetMax = Math.max.apply(null, targetGeneData);
					var targetMin = Math.min.apply(null, targetGeneData);
					
					// Create normalization function
					var normalizer = function(val, max, min) {
									return (val - min) / (max - min); 
								}
					
					/*
					 * Normalize input gene data
					 */
					for(var i = 0; i < inputGeneData.length; i++){
						newInputGeneData.push(normalizer(inputGeneData[i], inputMax, inputMin));
					}
					
					/*
					 * Normalize target gene data
					 */
					for(var i = 0; i < targetGeneData.length; i++){
						newTargetGeneData.push(normalizer(targetGeneData[i], targetMax, targetMin));
					}
					
					/*
					 * Update the plot with the normalized data
					 */
					var update = {
							y: [newInputGeneData, newTargetGeneData],
							title: "Correlation Line Graph (Normalized)" // TODO: Title change not working
					};
					Plotly.restyle(plotDiv, update, [1, 0])
					
					// Change button text to 'Original'
					$(eventTarget).html('Original');
					
					/*
					 * Add/update the entry in the normalizedContainer
					 */
					if(normalizedPlotResults.length == 0){
						normalizationContainer.push({
							plotDivId: plotDivId,
							isNormalized: true,
							originalData: [inputGeneData, targetGeneData]
						});
					} else {
						normalizedPlotResults[0].isNormalized = true;
					}
				} else { // Else: The plot is normalized
					
					/*
					 * Update the plot with the original data
					 */
					var update = {
							y: [normalizedPlotResults[0].originalData[0],normalizedPlotResults[0].originalData[1]],
							title: 'Correlation Line Graph (Original)' // TODO: Title change not working
					};
					Plotly.restyle(plotDiv, update, [1, 0])
					
					// Update the entry in the normalized container
					normalizedPlotResults[0].isNormalized = false; // No need to check if length != 0, to be in this block, it has to be
					
					// Change button text to 'Normalize'
					$(eventTarget).html('Normalize');
				}
			}
			
		
			
			function retrieveCorrelationData(pairwiseCorrelationDataAjaxRequestBody){
				var pairwiseGeneCorrelationData = null;
				
		    	 $.ajax({
		    	        type: "POST",
		    	        contentType: "application/json",
		    	        url: "/pairwise-correlation-data",
		    	        data: JSON.stringify(pairwiseCorrelationDataAjaxRequestBody),
		    	        dataType: 'json',
		    	        cache: false,
		    	        timeout: 600000,
		    	        success: function (data) {
							console.log(data);
							pairwiseGeneCorrelationData= data;
							attachPlotGraphic(pairwiseGeneCorrelationData, pairwiseCorrelationDataAjaxRequestBody)
		    	        },
		    	        error: function (e) {
							console.log(e);
							resultHtml = "<h4>Plot load failed</h4>"
		    	        }
		    	    });
		    	 
		    	 // Possibly of being null due to async
		    	 return pairwiseGeneCorrelationData;
			}
			
			function attachPlotGraphic(pairwiseGeneCorrelationData, pairwiseCorrelationDataAjaxRequestBody){
				var plotDivId= pairwiseCorrelationDataAjaxRequestBody.inputGene + '-' + pairwiseCorrelationDataAjaxRequestBody.targetGene + '-graph';
				

				// EEG MAGNITUDE
				var correlationData = [{
					name : pairwiseCorrelationDataAjaxRequestBody.inputGene,
					y : pairwiseGeneCorrelationData.inputGeneData,
					mode : 'lines+markers',
					marker : {
						color : 'blue',
						size : 8
					},
					line : {
						width : 4
					}
				}, {
					name : pairwiseCorrelationDataAjaxRequestBody.targetGene,
					y : pairwiseGeneCorrelationData.targetGeneData,
					mode : 'lines+markers',
					marker : {
						color : 'red',
						size : 8
					},
					line : {
						width : 4,
						dash : "dot"
					}
				}];
				Plotly.plot(plotDivId, correlationData, {
					title : 'Correlation Line Graph (Original)',
					xaxis : {
						title : "Expression Stage",
						range : [0, 104]
					},
					yaxis : {
						title : "Expression Score",
					},
					width: $('#result-panel').innerWidth() *.80
				});
				
				var d3 = Plotly.d3;
				var gd1 = d3.select('div[id="' + plotDivId + '"]');
				
				function plotsResize(){
					 // Getting the width of .content
		            var newTableWidth = $('#result-panel').innerWidth() * .95;
		            var newPlotWidth = $('#result-panel').innerWidth() * .85;
		            
		            // Apply width and height to two divs that are created by 
		            // Plotly. Fixed some issueswith hidden overfull elements.
		            $("table").css({
		                "width": newTableWidth + "px",
		            });
		            
		            $(".js-plotly-plot").css({
		                "width": newPlotWidth + "px",
		            });
		            $(".plotly").css({
		                "width": newPlotWidth + "px",
		            });

		            // Applying width and height to a new variable for Plotly
		            var update = {
		                width: newPlotWidth,
		            };
		            // Using Plotly's relayout-function with graph-name and 
		            // the variable with the new height and width
		            Plotly.relayout(gd1.node(), update);
				}
				
			   $(window).resize(function() {
					plotsResize();
		        });
			   
			   plotsResize();
			}
			
			 // Add event listener for opening and closing details
		    $('#correlation-results tbody').on('click', 'td.details-control', function () {
		        var tr = $(this).closest('tr');
		        var row = t.row( tr );
		 
		        if ( row.child.isShown() ) {
		            // This row is already open - close it
		            row.child.hide();
		            tr.removeClass('shown');
		        }
		        else {
		        	
					var pairwiseCorrelationDataAjaxRequestBody = {
							inputGene: finalResponseCorrelationResult.inputGene.dbIdentifier,
							targetGene: row.data()[2]
					};
					
		            // Open this row
		            row.child(attachPlotHtml(pairwiseCorrelationDataAjaxRequestBody)).show();
		            var pairwiseGeneCorrelationData = retrieveCorrelationData(pairwiseCorrelationDataAjaxRequestBody);
		            tr.addClass('shown');
		        }
		    } );
		/*]]>*/
	</script>
	<script>
		/*<![CDATA[*/
			var correlationOptionsTextAreaString = "";
			correlationOptions.forEach(function(correlationOption){
				correlationOptionsTextAreaString += correlationOption + '\n';
			});
			$("#correlation-options").val(correlationOptionsTextAreaString);
			
			//
			
			finalResponseCorrelationResult.correlationResults.sort(function(a,b) {
	  			if (a.corrResult.rVal < b.corrResult.rVal){
	     			return 1;
	  			} else if (a.corrResult.rVal > b.corrResult.rVal){
	    			return -1;
	  			} else {
	  				return 0;
	  			}
			});
			var rank = 1;
			finalResponseCorrelationResult.correlationResults.forEach(function(correlationResult){
		
				var buttonHtml = "";
				dataToggle = 'datatoggle="tooltip" data-placement="top" title="FlyMine '+ correlationResult.gene.dbIdentifier + ' Report"';
				buttonHtml += '<button type="button" class="btn btn-primary flymine-button" value="' + correlationResult.gene.dbIdentifier + '"' + dataToggle +'>FlyMine</button>';
				// Append any other buttons
				
				t.row.add([null, rank, correlationResult.gene.dbIdentifier, correlationResult.gene.secondaryIdentifier, correlationResult.gene.geneName, correlationResult.corrResult.rValueString, correlationResult.corrResult.pValSigFigs, buttonHtml]).draw(false);
				rank++;
			});
			// Now that buttons are added, activate tooltip for all of them
			$('.flymine-button').tooltip(); 
			
		    $('.flymine-button').on( 'click', function () {
		        var geneDbId = $(this).val();
		        var flymineUrl = 'http://www.flymine.org/query/portal.do?externalid=' + geneDbId + '&class=Gene&origin=fly-tran-webapp&organism=D.%20melanogaster'
		        window.open(flymineUrl);
		    } );
	    /*]]>*/
	</script>
</body>
</html>