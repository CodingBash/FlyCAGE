<!DOCTYPE HTML>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" xmlns:th="http://www.thymeleaf.org">
<!--<![endif]-->
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="Basheer Becerra's personal website." />
<meta name="keywords"
	content="Basheer, Becerra, Bash, developer, entrepreneur, researcher" />
<meta name="author" content="Basheer Becerra" />

<!-- Facebook and Twitter integration -->
<meta property="og:title" content="" />
<meta property="og:image" content="" />
<meta property="og:url" content="" />
<meta property="og:site_name" content="" />
<meta property="og:description" content="" />
<meta name="twitter:title" content="" />
<meta name="twitter:image" content="" />
<meta name="twitter:url" content="" />
<meta name="twitter:card" content="" />
<title>Fly Transcription</title>

<!-- Google Fonts -->
<link
	href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,700|Monsterrat:400,700|Merriweather:400,300italic,700'
	rel='stylesheet' type='text/css'></link>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
	integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
	crossorigin="anonymous" />

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet"
	href="https://cdn.datatables.net/1.10.15/css/jquery.dataTables.min.css" />
<link rel="stylesheet"
	href="https://cdn.datatables.net/buttons/1.3.1/css/buttons.dataTables.min.css" />
<link rel="stylesheet"
	href="https://cdn.datatables.net/responsive/2.1.1/css/responsive.dataTables.min.css" />
</head>
<style>
body {
	background-color: #E4E4E4
}

.table-wrapper {
	width: 95% !important;
	margin: auto;
}

#query-comment {
	width: 100%;
	height: 200px;
}

.extra-space {
	margin-top: 25px;
}

.query-inputs {
	width: 95% !important;
	margin: auto;
}

.panel-heading {
	height: 11em;
}

/* For Plotlyjs CSS */
div[id*="-graph"] {
	width: 100%;
}
</style>
<style>
.panel {
	border: 1px solid #5C0075;
	border-radius: 0;
	transition: box-shadow 0.5s;
}

.panel-footer .btn:hover {
	border: 1px solid #5C0075;
	background-color: #fff !important;
	color: #f4511e;
}

.panel-heading {
	color: #fff !important;
	background-color: #5C0075 !important;
	padding: 25px;
	border-bottom: 1px solid transparent;
	border-top-left-radius: 0px;
	border-top-right-radius: 0px;
	border-bottom-left-radius: 0px;
	border-bottom-right-radius: 0px;
}

.panel-footer {
	background-color: #fff !important;
}

.panel-footer h3 {
	font-size: 32px;
}

.panel-footer h4 {
	color: #aaa;
	font-size: 14px;
}

.panel-footer .btn {
	margin: 15px 0;
	background-color: #5C0075;
	color: #fff;
}
</style>

<style th:inline="text">
td.details-control {
	background: url([[@{/images/details_open.png}]]) no-repeat center center;
	cursor: pointer;
}

tr.shown td.details-control {
	background: url([[@{/images/details_close.png}]]) no-repeat center
		center;
}
</style>
<!-- TODO: Make form and query on top during lg, and side-by-side during lower -->
<body>
	<div class="container-fluid">
		<div class="text-center"></div>
		<div class="row">
			<div class="col-lg-6">
				<div class="row">
					<div class="col-sm-12">
						<div class="panel panel-default text-center">
							<div class="panel-heading">
								<h2>Query</h2>
								<h4>Shown below is the input query</h4>
							</div>
							<div class="panel-body">
								<div class="row">
									<div class="col-sm-6">
										<div class="row extra-space"></div>
										<div class="row">
											<div class="col-sm-6 text-center">
												<label for="input-identifier">Input Identifier:</label>
											</div>
											<div class="col-sm-6 text-left">
												<input type="text" id="input-identifier"
													class="query-inputs" th:value="${geneForm.inputIdentifier}"
													readonly="readonly"></input>
											</div>
										</div>
										<div class="row extra-space"></div>
										<div class="row">
											<div class="col-sm-6 text-center">
												<label for="gene-species">Organism:</label>
											</div>
											<div class="col-sm-6 text-left">
												<input type="text" id="gene-species" class="query-inputs"
													th:value="${geneForm.geneSpecies}" readonly="readonly"></input>
											</div>
										</div>
										<div class="row extra-space"></div>
										<div class="row">
											<div class="col-sm-6 text-center">
												<label for="correlation-options">Correlation:</label>
											</div>
											<div class="col-sm-6 text-left">
												<input type="text" id="correlation-options"
													class="query-inputs" readonly="readonly"></input>
											</div>
										</div>
									</div>
									<div class="col-sm-6">
										<label for="query-comment">Comment:</label>
										<textarea id="query-comment"
											th:text="${geneForm.queryComment}" readonly="readonly">
										</textarea>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-sm-12 hidden-xs visible-lg">
						<div th:include="fragments :: gene-form"></div>
					</div>
				</div>
			</div>
			<div class="col-lg-6">
				<div class="row">
					<div class="col-xs-12">
						<div id="result-panel" class="panel panel-default text-center">
							<div class="panel-heading">
								<h2>Results</h2>
								<h4>Shown below are all of the highly correlated genes
									based on mRNA expression by stage data</h4>
							</div>
							<div class="panel-body">
								<div class="row table-row">
									<div class="table-wrapper">
										<table id="correlation-results"
											class="stripe row-border compact nowrap"
											style="width: 100%; margin: auto;" cellspacing="0">
											<thead>
												<tr>
													<th></th>
													<th>RANK</th>
													<th>DB-ID</th>
													<th>SECONDARY-ID</th>
													<th>GENE-NAME</th>
													<th>R-VAL</th>
													<th>P-VAL</th>
													<th>ACTIONS</th>
												</tr>
											</thead>
											<tbody>
											</tbody>
											<tfoot>
												<tr>
													<th></th>
													<th>RANK</th>
													<th>DB-ID</th>
													<th>SECONDARY-ID</th>
													<th>GENE-NAME</th>
													<th>R-VAL</th>
													<th>P-VAL</th>
													<th>ACTIONS</th>
												</tr>
											</tfoot>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-sm-12 visible-xs visible-md hidden-lg">
						<div th:include="fragments :: gene-form"></div>
					</div>
				</div>
			</div>
		</div>
	</div>


	<script src="https://code.jquery.com/jquery-3.2.1.min.js"
		integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
		crossorigin="anonymous"></script>
	<script
		src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
		integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
		crossorigin="anonymous"></script>
	<script
		src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>

	<!-- BELOW: Links for datatable buttons -->
	<script
		src="https://cdn.datatables.net/buttons/1.3.1/js/dataTables.buttons.min.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
	<script
		src="https://cdn.rawgit.com/bpampuch/pdfmake/0.1.27/build/pdfmake.min.js"></script>
	<script
		src="https://cdn.rawgit.com/bpampuch/pdfmake/0.1.27/build/vfs_fonts.js"></script>
	<script
		src="https://cdn.datatables.net/buttons/1.3.1/js/buttons.html5.min.js"></script>

	<script
		src="https://cdn.datatables.net/responsive/2.1.1/js/dataTables.responsive.min.js"></script>
	<!-- ABOVE: Links for datatable buttons -->
	<!-- BELOW PlotlyJS scripts -->
	<script src="https://d3js.org/d3.v3.min.js"></script>
	<script src="https://cdn.plot.ly/plotly-1.2.0.min.js"></script>
	<!-- ABOVE PlotlyJS scripts -->

	<script th:inline="javascript">
	/*<![CDATA[*/
		var correlationOptions = [[${geneForm.correlationOptions}]];
	    var finalResponseCorrelationResult = [[${result}]];

	/*]]>*/
	</script>
	<script>
		/*<![CDATA[*/
			var t = $('#correlation-results').DataTable({
			  "columnDefs": [ {
			      "targets": 0,
			      "data": null,
			      "orderable": false,
			      "className": 'details-control',
			      "defaultContent": ''
			    },  { responsivePriority: 1, targets: 0 },
		        { responsivePriority: 2, targets: 2 },
		        { responsivePriority: 3, targets: 5 },
		        { responsivePriority: 4, targets: 6 },
		        { responsivePriority: 5, targets: 7 },
		        { responsivePriority: 6, targets: 4 }],
				aaSorting : [ [ 5, 'des' ] ],
				"pageLength" : 25,
				dom: 'Bfrtip',
				buttons: [
		            'copy', 'csv', 'excel', 'pdf'
		        ],
		        "responsive": {
		            "details": false
		        }
			});
			
			/* Formatting function for row details - modify as you need */
		    function attachPlotHtml(pairwiseCorrelationDataAjaxRequestBody) {
		    	var plotDivId= pairwiseCorrelationDataAjaxRequestBody.inputGene + '-' + pairwiseCorrelationDataAjaxRequestBody.targetGene + '-graph';
		        return '<div id="' + plotDivId + '"></div>'
		    }
			
			function retrieveCorrelationData(pairwiseCorrelationDataAjaxRequestBody){
				var pairwiseGeneCorrelationData = null;
				
		    	 $.ajax({
		    	        type: "POST",
		    	        contentType: "application/json",
		    	        url: "/pairwise-correlation-data",
		    	        data: JSON.stringify(pairwiseCorrelationDataAjaxRequestBody),
		    	        dataType: 'json',
		    	        cache: false,
		    	        timeout: 600000,
		    	        success: function (data) {
							console.log(data);
							pairwiseGeneCorrelationData= data;
							attachPlotGraphic(pairwiseGeneCorrelationData, pairwiseCorrelationDataAjaxRequestBody)
		    	        },
		    	        error: function (e) {
							console.log(e);
							resultHtml = "<h4>Plot load failed</h4>"
		    	        }
		    	    });
		    	 
		    	 // Possibly of being null due to async
		    	 return pairwiseGeneCorrelationData;
			}
			
			function attachPlotGraphic(pairwiseGeneCorrelationData, pairwiseCorrelationDataAjaxRequestBody){
				var plotDivId= pairwiseCorrelationDataAjaxRequestBody.inputGene + '-' + pairwiseCorrelationDataAjaxRequestBody.targetGene + '-graph';
				

				// EEG MAGNITUDE
				var correlationData = [{
					name : pairwiseCorrelationDataAjaxRequestBody.inputGene,
					y : pairwiseGeneCorrelationData.inputGeneData,
					mode : 'lines',
					marker : {
						color : 'blue',
						size : 8
					},
					line : {
						width : 4
					}
				}, {
					name : pairwiseCorrelationDataAjaxRequestBody.targetGene,
					y : pairwiseGeneCorrelationData.targetGeneData,
					mode : 'lines',
					marker : {
						color : 'red',
						size : 8
					},
					line : {
						width : 4
					}
				}];
				Plotly.plot(plotDivId, correlationData, {
					title : 'Correlation Plot',
					xaxis : {
						title : "Expression Stage",
						range : [0, 104]
					},
					yaxis : {
						title : "Expression Score",
					},
					width: $('#result-panel').innerWidth() *.80
				});
				
				var d3 = Plotly.d3;
				var gd1 = d3.select('div[id="' + plotDivId + '"]');
				
				function plotsResize(){
					 // Getting the width of .content
		            var newTableWidth = $('#result-panel').innerWidth() * .95;
		            var newPlotWidth = $('#result-panel').innerWidth() * .85;
		            
		            // Apply width and height to two divs that are created by 
		            // Plotly. Fixed some issueswith hidden overfull elements.
		            $("table").css({
		                "width": newTableWidth + "px",
		            });
		            
		            $(".js-plotly-plot").css({
		                "width": newPlotWidth + "px",
		            });
		            $(".plotly").css({
		                "width": newPlotWidth + "px",
		            });
		   

		            // Applying width and height to a new variable for Plotly
		            var update = {
		                width: newPlotWidth,
		            };
		            // Using Plotly's relayout-function with graph-name and 
		            // the variable with the new height and width
		            Plotly.relayout(gd1.node(), update);
				}
				
			   $(window).resize(function() {
					plotsResize();
		        });
			   
			   plotsResize();
			}
			
			 // Add event listener for opening and closing details
		    $('#correlation-results tbody').on('click', 'td.details-control', function () {
		        var tr = $(this).closest('tr');
		        var row = t.row( tr );
		 
		        if ( row.child.isShown() ) {
		            // This row is already open - close it
		            row.child.hide();
		            tr.removeClass('shown');
		        }
		        else {
		        	
					var pairwiseCorrelationDataAjaxRequestBody = {
							inputGene: finalResponseCorrelationResult.inputGene.dbIdentifier,
							targetGene: row.data()[2]
					};
					
		            // Open this row
		            row.child(attachPlotHtml(pairwiseCorrelationDataAjaxRequestBody)).show();
		            var pairwiseGeneCorrelationData = retrieveCorrelationData(pairwiseCorrelationDataAjaxRequestBody);
		            tr.addClass('shown');
		        }
		    } );
		/*]]>*/
	</script>
	<script>
		/*<![CDATA[*/
			var correlationOptionsTextAreaString = "";
			correlationOptions.forEach(function(correlationOption){
				correlationOptionsTextAreaString += correlationOption + '\n';
			});
			$("#correlation-options").val(correlationOptionsTextAreaString);
			
			//
			
			finalResponseCorrelationResult.correlationResults.sort(function(a,b) {
	  			if (a.corrResult.rVal < b.corrResult.rVal){
	     			return 1;
	  			} else if (a.rVal > b.rVal){
	    			return -1;
	  			} else {
	  				return 0;
	  			}
			});
			var rank = 1;
			finalResponseCorrelationResult.correlationResults.forEach(function(correlationResult){
		
				var buttonHtml = "";
				buttonHtml += '<button type="button" class="btn btn-primary flymine-button" value="' + correlationResult.gene.dbIdentifier + '">FlyMine</button>';
				// Append any other buttons
				
				t.row.add([null, rank, correlationResult.gene.dbIdentifier, correlationResult.gene.secondaryIdentifier, correlationResult.gene.geneName, correlationResult.corrResult.rValueString, correlationResult.corrResult.pValSigFigs, buttonHtml]).draw(false);
				rank++;
			});
			
		    $('.flymine-button').on( 'click', function () {
		        var geneDbId = $(this).val();
		        window.open('http://www.flymine.org/flymine/keywordSearchResults.do?searchTerm=' + geneDbId);
		    } );
	    /*]]>*/
	</script>
</body>
</html>